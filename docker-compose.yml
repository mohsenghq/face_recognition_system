services:
  capture:
    build: ./modules/capture
    container_name: capture
    restart: always
    env_file: .env
    volumes:
      - ${VIDEO_SOURCE}:/app/test.mp4:ro
    ports:
      - "8001:8000"
    networks:
      - face_net

  detector:
    build: ./modules/detector
    container_name: detector
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
    networks:
      - face_net

  embedding:
    build: ./modules/embedding
    container_name: embedding
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
    networks:
      - face_net

  super_resolution:
    build: ./modules/super_resolution
    container_name: super_resolution
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
    networks:
      - face_net

  matching:
    build: ./modules/matching
    container_name: matching
    networks:
      - face_net

  tracker:
    build: ./modules/tracker
    container_name: tracker
    networks:
      - face_net

  rabbitmq:
    image: "rabbitmq:3.13-management"
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - face_net

  vector_db:
    image: milvusdb/milvus:v2.4.0
    container_name: vector_db
    environment:
      - MILVUS_LOG_LEVEL=info
    ports:
      - "19530:19530"
    networks:
      - face_net

  monitoring:
    build: ./modules/monitoring
    container_name: monitoring
    networks:
      - face_net

networks:
  face_net:
    driver: bridge
